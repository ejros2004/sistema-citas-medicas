python manage.py shell

from django.contrib.auth.models import User
from autenticacion.models import PerfilUsuario
import sys

print("=" * 60)
print("CORRECCIÃ“N DE PERFILES DE USUARIO")
print("=" * 60)

# 1. Corregir todos los superusers
superusers = User.objects.filter(is_superuser=True)
print(f"\nğŸ“‹ Superusers encontrados: {superusers.count()}")

for user in superusers:
    try:
        perfil, created = PerfilUsuario.objects.get_or_create(user=user)
        
        if created:
            perfil.tipo_usuario = 'admin'
            perfil.save()
            print(f"âœ… PERFIL CREADO: {user.username} -> ADMIN")
        elif perfil.tipo_usuario != 'admin':
            old_type = perfil.tipo_usuario
            perfil.tipo_usuario = 'admin'
            perfil.save()
            print(f"ğŸ”„ CORREGIDO: {user.username} de {old_type.upper()} -> ADMIN")
        else:
            print(f"âœ“ OK: {user.username} ya es ADMIN")
            
    except Exception as e:
        print(f"âŒ ERROR con {user.username}: {str(e)}")

# 2. Corregir usuarios normales
normal_users = User.objects.filter(is_superuser=False)
print(f"\nğŸ“‹ Usuarios normales encontrados: {normal_users.count()}")

for user in normal_users:
    try:
        # Solo crear si no existe
        perfil, created = PerfilUsuario.objects.get_or_create(user=user)
        if created:
            # Mantener el valor por defecto (paciente)
            print(f"âœ… PERFIL CREADO: {user.username} -> {perfil.tipo_usuario.upper()}")
        else:
            print(f"âœ“ OK: {user.username} ya tiene perfil ({perfil.tipo_usuario})")
    except Exception as e:
        print(f"âŒ ERROR con {user.username}: {str(e)}")

# 3. Verificar usuarios sin perfil
print(f"\nğŸ” Verificando usuarios sin perfil...")
users_without_profile = []
for user in User.objects.all():
    try:
        user.perfil  # Intentar acceder al perfil
    except PerfilUsuario.DoesNotExist:
        users_without_profile.append(user.username)

if users_without_profile:
    print(f"âš ï¸ Usuarios sin perfil encontrados: {len(users_without_profile)}")
    for username in users_without_profile:
        print(f"   - {username}")
        
    # Crear perfiles para los que faltan
    print("\nğŸ› ï¸ Creando perfiles faltantes...")
    for username in users_without_profile:
        user = User.objects.get(username=username)
        try:
            if user.is_superuser:
                PerfilUsuario.objects.create(user=user, tipo_usuario='admin')
                print(f"   âœ… {username} -> ADMIN (creado)")
            else:
                PerfilUsuario.objects.create(user=user)
                print(f"   âœ… {username} -> PACIENTE (creado)")
        except Exception as e:
            print(f"   âŒ Error creando perfil para {username}: {str(e)}")
else:
    print("âœ… Todos los usuarios tienen perfil")

print("\n" + "=" * 60)
print("CORRECCIÃ“N COMPLETADA")
print("=" * 60)

# Mostrar resumen final
print("\nğŸ“Š RESUMEN FINAL DE PERFILES:")
for perfil in PerfilUsuario.objects.all().select_related('user'):
    superuser_marker = "ğŸ‘‘ " if perfil.user.is_superuser else "  "
    print(f"{superuser_marker}{perfil.user.username:20} -> {perfil.tipo_usuario.upper():10} (Superuser: {perfil.user.is_superuser})")